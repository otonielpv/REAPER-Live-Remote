<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <title>Reaper Live Remote - Songs</title>
  <link rel="stylesheet" href="css/app.css">
</head>
<body>
  <div class="app-container">
    <!-- Header -->
    <header class="app-header">
      <h1 data-i18n="songs">Songs</h1>
      <div class="header-actions">
        <button id="btn-lang-toggle" class="icon-btn" title="Toggle Language">
          EN
        </button>
        <button id="btn-refresh" class="icon-btn" data-i18n-title="reload" title="Reload">
          üîÑ
        </button>
      </div>
    </header>

    <!-- Main Content -->
    <main class="app-main">
      <div id="song-list" class="song-list">
        <!-- Se llenar√° din√°micamente con JavaScript -->
      </div>
    </main>

    <!-- Footer con info de conexi√≥n -->
    <footer class="app-footer">
      <div class="connection-status">
        <span id="status-indicator" class="status-indicator"></span>
        <span id="status-text" data-i18n="connecting">Connecting...</span>
      </div>
    </footer>
  </div>

  <!-- Scripts -->
  <script type="module">
    import * as api from './js/api.js';
    import * as state from './js/state.js';
    import * as ui from './js/ui.js';
    import * as utils from './js/utils.js';
    import * as i18n from './js/i18n.js';

    // Initialize i18n
    await i18n.initI18n();

    // Elementos del DOM
    const songListContainer = document.getElementById('song-list');
    const btnRefresh = document.getElementById('btn-refresh');
    const btnLangToggle = document.getElementById('btn-lang-toggle');
    const statusIndicator = document.getElementById('status-indicator');
    const statusText = document.getElementById('status-text');

    // Control de peticiones en vuelo
    let loadingPromise = null;
    let autoRefreshInterval = null;

    /**
     * Limpiar estado cuando se carga index.html
     */
    function initializeState() {
      // Asegurar que no haya polling activo
      if (api.isPolling()) {
        console.log('üßπ Deteniendo polling residual del mixer');
        api.stopPolling();
      }
      // Resetear la canci√≥n actual
      state.setCurrentSong(null);
      console.log('‚ú® Estado inicializado para vista de canciones');
    }

    // Inicializar estado
    initializeState();

    /**
     * Cargar canciones desde REAPER
     */
    async function loadSongs() {
      // Evitar cargas simult√°neas
      if (loadingPromise) {
        console.log('‚è≥ Ya hay una carga en progreso, esperando...');
        return loadingPromise;
      }

      loadingPromise = (async () => {
        try {
          ui.showLoading(songListContainer);
          
          // Inicializar API
          await api.init();
          
          // Cargar regiones (canciones)
          const regions = await api.getRegions();
          console.log('üì¶ Regiones recibidas:', regions);
          
          // Actualizar estado
          state.setRegions(regions);
          
          // Obtener lista de canciones
          const songs = state.getSongs();
          console.log('üéµ Canciones procesadas:', songs);
          
          // Renderizar lista
          ui.renderSongList(songListContainer, songs);
          
          // Actualizar estado de conexi√≥n
          updateConnectionStatus(true);
          
          console.log(`‚úÖ Cargadas ${songs.length} canciones`);
          
        } catch (error) {
          console.error('‚ùå Error cargando canciones:', error);
          songListContainer.innerHTML = `
            <div class="error-state">
              <p data-i18n="error_connection">Connection Error</p>
              <p class="hint" data-i18n="check_reaper">Check that REAPER is open and web server is enabled</p>
              <p class="hint" data-i18n="connecting_to">Connecting to: http://192.168.1.39:8080</p>
              <button class="btn-retry" onclick="window.location.reload()" data-i18n="retry">Retry</button>
            </div>
          `;
          updateConnectionStatus(false);
        } finally {
          loadingPromise = null;
        }
      })();

      return loadingPromise;
    }

    /**
     * Actualizar indicador de estado de conexi√≥n
     */
    function updateConnectionStatus(connected) {
      if (connected) {
        statusIndicator.className = 'status-indicator connected';
        statusText.textContent = i18n.t('connected');
      } else {
        statusIndicator.className = 'status-indicator disconnected';
        statusText.textContent = i18n.t('disconnected');
      }
    }

    /**
     * Event listeners
     */
    btnRefresh.addEventListener('click', () => {
      loadSongs();
    });

    btnLangToggle.addEventListener('click', async () => {
      const currentLang = i18n.getCurrentLang();
      const newLang = currentLang === 'es' ? 'en' : 'es';
      await i18n.setLanguage(newLang);
    });

    // Cargar al iniciar
    loadSongs();
    
    // Recargar peri√≥dicamente (cada 30 segundos) solo si la p√°gina est√° visible
    autoRefreshInterval = setInterval(() => {
      if (document.visibilityState === 'visible') {
        loadSongs();
      }
    }, 30000);
    
    // Limpiar cuando se cierra la pesta√±a
    window.addEventListener('beforeunload', () => {
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
      }
    });
    
  </script>
</body>
</html>
